# 기능 명세서

> Lemon Protocol 전체 기능 상세 명세

---

## 목차

- [기능 개요](#기능-개요)
- [F1: AI 챗봇](#f1-ai-챗봇)
- [F2: 콘텐츠 라이브러리](#f2-콘텐츠-라이브러리)
- [F3: API 키 관리](#f3-api-키-관리)
- [F4: 사용자 계정](#f4-사용자-계정)
- [F5: 분석 결과 내보내기](#f5-분석-결과-내보내기)
- [비기능 요구사항](#비기능-요구사항)

---

## 기능 개요

### 기능 우선순위

| 우선순위 | 기능 | 설명 | Phase |
|:--------:|------|------|:-----:|
| P0 | AI 챗봇 | 핵심 분석 엔진 | MVP |
| P0 | BYOK API 키 | 사용자 API 키 입력 | MVP |
| P1 | 콘텐츠 라이브러리 | 프로토콜/이론 열람 | MVP |
| P1 | 분석 결과 공유 | 결과 복사/내보내기 | MVP |
| P2 | 사용자 계정 | 로그인/히스토리 | Phase 2 |
| P2 | 프로토콜 커스터마이징 | 템플릿 수정 | Phase 2 |
| P3 | 커뮤니티 | 사례 공유 | Phase 3 |

---

## F1: AI 챗봇

### F1.1 상황 입력

**기능 설명**: 사용자가 관계 상황을 자연어로 입력

**입력 형태**:
- 자유 텍스트 입력
- 음성 입력 (Web Speech API) - Phase 2
- 템플릿 기반 입력 (선택적)

**입력 예시**:
```
"여자친구가 자꾸 읽씹해요. 바쁘다고 하는데 진짜인지 모르겠어요."
"남자친구가 게임만 하고 저한테 관심이 없어요"
"장거리 연애 중인데 연락이 점점 줄어들어요"
```

**UI 스펙**:
```
┌─────────────────────────────────────────────────────┐
│  💬 어떤 상황인지 편하게 말씀해 주세요              │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │                                             │   │
│  │  [텍스트 입력 영역]                         │   │
│  │                                             │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  [🎤 음성] [📝 템플릿] [✨ 예시 보기]    [분석하기 →]│
└─────────────────────────────────────────────────────┘
```

---

### F1.2 AI 분석

**분석 프로세스**:

```
입력 텍스트
    │
    ▼
┌─────────────────┐
│ 1. 상황 파싱    │ → 키워드, 관계유형, 감정톤 추출
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 2. 이론 매칭    │ → Gottman, 애착이론, NVC 등 연결
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 3. 문제 진단    │ → 핵심 원인 분석
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 4. 프로토콜 생성│ → 맞춤형 해결책 + 스크립트
└─────────────────┘
    │
    ▼
분석 결과
```

**출력 구조**:

```markdown
## 🔍 상황 분석

### 핵심 문제
[비딩 실패 (Failed Bids)] - Gottman 이론 기반

### 문제 메커니즘
1. A의 연결 요청 (비딩)
2. B의 무응답 (Turn Away)
3. A의 정서적 축적
4. 갈등 에스컬레이션

---

## 💡 해결 프로토콜

### "레몬" 프로토콜 적용

[프로토콜 상세 설명...]

---

## 📝 대화 스크립트 예시

**Before (기존 방식)**:
> A: "왜 읽씹해?"
> B: "바빴어"
> A: "바빴으면 말이라도 해주지"

**After (프로토콜 적용)**:
> A: "연락하고 싶었어"
> B: "레몬"
> A: "알겠어. 나중에 연락해줘"

---

## ✅ 실행 체크리스트

- [ ] 상대방과 프로토콜 합의하기
- [ ] 암구호 정하기
- [ ] 3일간 테스트 적용
```

---

### F1.3 실시간 스트리밍

**기능 설명**: AI 응답을 실시간으로 스트리밍

**기술 스펙**:
- Server-Sent Events (SSE)
- Edge Function 기반
- 토큰 단위 스트리밍

**UX**:
```
분석 중... ████████░░░░░░░░ 50%

🔍 상황을 분석하고 있어요...
💡 적합한 이론을 찾고 있어요...
📝 맞춤형 프로토콜을 생성 중이에요...
```

---

### F1.4 대화 컨텍스트

**기능 설명**: 이전 대화 기억하여 후속 질문 지원

**예시**:
```
[이전 대화]
사용자: "여자친구가 읽씹해요"
AI: [분석 결과 - 레몬 프로토콜 제안]

[후속 질문]
사용자: "근데 상대방이 이 프로토콜을 싫어하면 어떡해요?"
AI: [이전 컨텍스트를 고려한 응답]
```

**구현**:
- 세션 기반 메시지 히스토리
- 최근 10개 메시지 컨텍스트 유지
- 토큰 제한 고려

---

## F2: 콘텐츠 라이브러리

### F2.1 프로토콜 라이브러리

**구성**:

| 프로토콜 | 상황 | 핵심 |
|----------|------|------|
| 🍋 레몬 | 저에너지 상태 전달 | 축약 신호로 상태 공유 |
| 🍈 라임 | 혼자 있고 싶음 | 공간 필요 신호 |
| 🍊 오렌지 | 화났지만 대화 가능 | 감정 상태 표현 |
| 🍎 사과 | 잘못 인정 | 사과 의사 전달 |
| 🍇 포도 | 보고 싶음 | 애정 표현 |

**프로토콜 카드 UI**:
```
┌─────────────────────────────────────────┐
│  🍋 레몬 프로토콜                       │
├─────────────────────────────────────────┤
│  "저에너지 상태 전달 신호"               │
│                                         │
│  📌 사용 상황                           │
│  • 바쁘거나 지쳐서 길게 대화하기 힘들 때 │
│  • 예쁘게 말할 에너지가 없을 때          │
│                                         │
│  📖 사용법                              │
│  B: "레몬"                              │
│  A: (욕구 명시) "게임하고 싶었어"        │
│  B: 👍                                  │
│                                         │
│  [상세 보기]  [적용 예시]  [수정하기]    │
└─────────────────────────────────────────┘
```

---

### F2.2 이론 가이드

**제공 이론**:

1. **Gottman 비딩 이론**
   - 비딩(Bidding)의 개념
   - Turn Toward / Turn Away / Turn Against
   - 관계 예측력

2. **정서적 노동 (Emotional Labor)**
   - 감정 조절 비용
   - 비대칭성 문제
   - 분담 방법

3. **애착 이론 (Attachment Theory)**
   - 불안형 / 회피형 / 안정형
   - 자기 패턴 인식
   - 상대 이해

4. **비폭력 대화 (NVC)**
   - 관찰-느낌-필요-부탁
   - 실전 적용법

---

### F2.3 사례 아카이브

**구성**:
- 익명화된 실제 사례
- 문제 상황 → 분석 → 해결 프로세스
- 사용자 기여 (Phase 3)

**필터**:
- 상황 유형 (읽씹, 싸움, 질투 등)
- 관계 유형 (연인, 부부, 장거리)
- 해결 프로토콜

---

## F3: API 키 관리

### F3.1 BYOK (Bring Your Own Key)

**지원 제공자**:
- OpenAI (GPT-4, GPT-4o-mini)
- Google (Gemini Pro, Gemini Flash)

**입력 UI**:
```
┌─────────────────────────────────────────────────────┐
│  🔑 API 키 설정                                     │
│                                                     │
│  AI 분석을 사용하려면 API 키가 필요해요.            │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │ OpenAI                              [활성] ✓│   │
│  │ sk-...••••••••••••••                       │   │
│  │                          [수정] [삭제]      │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │ Google Gemini                       [비활성]│   │
│  │ API 키를 입력해주세요                        │   │
│  │ [키 입력...]                    [저장]      │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ℹ️ API 키는 브라우저에 암호화되어 저장됩니다.     │
│     서버에 전송될 때만 일시적으로 복호화됩니다.    │
└─────────────────────────────────────────────────────┘
```

---

### F3.2 키 저장 옵션

| 옵션 | 설명 | 보안 |
|------|------|------|
| 세션 저장 | 브라우저 닫으면 삭제 | ★★★★★ |
| 로컬 저장 | 브라우저에 암호화 저장 | ★★★★☆ |
| 계정 저장 | Supabase에 암호화 저장 | ★★★☆☆ |

---

### F3.3 사용량 표시

```
┌─────────────────────────────────────────┐
│  📊 이번 세션 사용량                    │
│                                         │
│  입력 토큰:  1,234                      │
│  출력 토큰:  2,567                      │
│  예상 비용:  ~$0.05                     │
│                                         │
│  ⚠️ 실제 비용은 제공자 대시보드에서      │
│     확인하세요.                          │
└─────────────────────────────────────────┘
```

---

## F4: 사용자 계정

### F4.1 인증 (Phase 2)

**지원 방식**:
- 이메일/비밀번호
- Google OAuth
- GitHub OAuth (개발자용)

---

### F4.2 히스토리 (Phase 2)

**저장 항목**:
- 상담 세션
- 적용한 프로토콜
- 북마크한 콘텐츠

**히스토리 UI**:
```
┌─────────────────────────────────────────────────────┐
│  📚 상담 히스토리                                   │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │ 2026-01-14                                  │   │
│  │ "읽씹 문제"                                 │   │
│  │ → 레몬 프로토콜 적용                        │   │
│  │                           [이어서 대화하기]  │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │ 2026-01-10                                  │   │
│  │ "장거리 연락 빈도"                          │   │
│  │ → 연락 스케줄링 프로토콜                    │   │
│  │                           [이어서 대화하기]  │   │
│  └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
```

---

## F5: 분석 결과 내보내기

### F5.1 복사

- 마크다운 형식 복사
- 플레인 텍스트 복사

### F5.2 공유

- 링크 생성 (24시간 유효)
- SNS 공유 (요약 카드)

### F5.3 다운로드

- PDF 내보내기
- Notion 형식 (.md)
- Obsidian 형식 (.md with YAML)

---

## 비기능 요구사항

### 성능

| 항목 | 목표 |
|------|------|
| 첫 페이지 로드 | < 2초 (LCP) |
| AI 첫 토큰 응답 | < 1초 |
| 전체 분석 완료 | < 30초 |
| 라이브러리 검색 | < 500ms |

### 접근성

- WCAG 2.1 AA 준수
- 키보드 네비게이션
- 스크린 리더 지원
- 다크 모드

### 반응형

- Desktop (1024px+)
- Tablet (768px - 1023px)
- Mobile (< 768px)

### 브라우저 지원

- Chrome 90+
- Firefox 90+
- Safari 15+
- Edge 90+

---

*문서 버전: 1.0*
*최종 수정: 2026-01-14*
